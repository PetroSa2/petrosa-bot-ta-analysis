# Signal Flow Diagnostic Report
**Date**: October 17, 2025
**Issue**: Signals from ta-bot not reaching tradeengine

## Executive Summary

Signals are successfully:
1. ‚úÖ Generated by ta-bot strategies
2. ‚úÖ Persisted to MySQL database
3. ‚úÖ Published to NATS by ta-bot

But:
4. ‚ùå **Never received by tradeengine** despite consumer running and subscribed

## Configuration Verification

### ta-bot Configuration
- **NATS URL**: `nats://nats-server.nats.svc.cluster.local:4222`
- **NATS Enabled**: `true`
- **Publishing Topic**: `signals.trading` (hardcoded in `publisher.py` line 134)
- **Connection Status**: ‚úÖ Connected
- **Recent Activity**: Publishing signals successfully (last: 15:55:17)

### tradeengine Configuration
- **NATS URL**: `nats://nats-server.nats.svc.cluster.local:4222`
- **NATS Enabled**: `true`
- **Subscription Topic**: `signals.trading` (from shared/config.py)
- **Connection Status**: ‚úÖ Connected and subscribed
- **Consumer Status**: ‚úÖ Running (heartbeat every 30s, Loop #8250+)
- **Messages Received**: ‚ùå **ZERO** (no "üì® NATS MESSAGE RECEIVED" logs)

### NATS Server
- **Namespace**: `nats`
- **Pod**: `nats-server-5d859c86df-42s4j`
- **Service IP**: `10.152.183.189:4222`
- **Status**: Running (98 days uptime)
- **Connectivity**: ‚úÖ Both services can connect

## Log Evidence

### ta-bot Logs (Recent)
```
2025-10-17 15:55:17 [info] Publishing signal via NATS: golden_trend_sync - buy
2025-10-17 15:55:17 [info] Signal published successfully via NATS: golden_trend_sync
2025-10-17 15:55:17 [info] Publishing signal via NATS: ichimoku_cloud_momentum - buy
2025-10-17 15:55:17 [info] Signal published successfully via NATS: ichimoku_cloud_momentum
```

### tradeengine Logs (Recent)
```
2025-10-17 15:52:02 - INFO - üíì NATS consumer heartbeat | Loop #8010 | Running: True | NC connected: True | Subscription: True
2025-10-17 15:52:32 - INFO - üíì NATS consumer heartbeat | Loop #8040 | Running: True | NC connected: True | Subscription: True
... [NO MESSAGE RECEIVED LOGS] ...
```

### tradeengine Startup Logs
```
2025-10-17 13:37:51 - INFO - üöÄ STARTING NATS CONSUMER | Subject: signals.trading | No queue group (duplicate detection in dispatcher)
2025-10-17 13:37:51 - INFO - Subscribing to subject: signals.trading with callback: <bound method SignalConsumer._message_handler>
2025-10-17 13:37:51 - INFO - ‚úÖ NATS SUBSCRIPTION ACTIVE | Subject: signals.trading | Waiting for signals...
```

## Root Cause Hypothesis

### Most Likely Causes

#### 1. **NATS Connection Timing Issue** (HIGH PROBABILITY)
- ta-bot's publisher might be connecting to NATS **BEFORE** tradeengine subscribes
- Messages published before subscription are lost in NATS (no persistence)
- **Evidence**: tradeengine started at 13:37:51, ta-bot at 15:38:14 (2 hours later)
- **Test**: Restart ta-bot and check if first signal after restart reaches tradeengine

#### 2. **NATS Client Library Issue** (MEDIUM PROBABILITY)
- ta-bot uses `nats` Python library (from requirements.txt)
- tradeengine uses `nats` Python library (from requirements.txt)
- Potential version mismatch or serialization issue
- **Test**: Verify both use same NATS client version

#### 3. **Message Format Mismatch** (LOW PROBABILITY)
- tradeengine expects specific Signal format (contracts/signal.py)
- ta-bot sends Signal format (ta_bot/models/signal.py)
- Mismatch could cause silent rejection
- **Evidence**: Would show error logs in tradeengine, but none present

#### 4. **NATS Subject Case Sensitivity** (VERY LOW PROBABILITY)
- Both use `signals.trading` (verified in code)
- NATS subjects are case-sensitive
- **Evidence**: No case mismatch found

## Code Changes Implemented

### 1. Enhanced Logging in ta-bot
**Files Modified**:
- `ta_bot/main.py`: Added startup NATS connection validation
- `ta_bot/services/publisher.py`: Added detailed publish request/complete logging
- `ta_bot/services/nats_listener.py`: Added pre/post publisher call logging
- `ta_bot/health.py`: Added NATS publisher connection health check

**New Log Patterns** (will appear after deployment):
```
üì§ PUBLISH REQUEST: X signals | NATS Connected: True | REST Enabled: False
üöÄ PUBLISHING X signals to Trade Engine via publisher
‚úÖ Publisher call completed for X signals
‚úÖ PUBLISH COMPLETE: X signals dispatched
```

## Next Steps

### Immediate Actions Required

1. **Deploy Updated ta-bot** with enhanced logging
   ```bash
   cd /Users/yurisa2/petrosa/petrosa-bot-ta-analysis
   make build push deploy
   ```

2. **Monitor Logs After Deployment**
   ```bash
   # ta-bot logs
   kubectl --kubeconfig=k8s/kubeconfig.yaml logs -n petrosa-apps deployment/petrosa-ta-bot -f | grep -E "(PUBLISH|üöÄ|‚úÖ|‚ùå)"

   # tradeengine logs
   kubectl --kubeconfig=k8s/kubeconfig.yaml logs -n petrosa-apps deployment/petrosa-tradeengine -f | grep -E "(MESSAGE RECEIVED|SIGNAL PARSED)"
   ```

3. **Check Health Endpoint**
   ```bash
   kubectl --kubeconfig=k8s/kubeconfig.yaml port-forward -n petrosa-apps deployment/petrosa-ta-bot 8000:8000
   curl http://localhost:8000/health
   # Look for: "nats_publisher": "connected"
   ```

4. **Test Signal Generation**
   - Wait for next candle completion (5m interval)
   - Check ta-bot logs for "üöÄ PUBLISHING" message
   - Check tradeengine logs for "üì® NATS MESSAGE RECEIVED"

### If Issue Persists

1. **Restart Both Services** (to ensure connection timing)
   ```bash
   kubectl --kubeconfig=k8s/kubeconfig.yaml rollout restart deployment/petrosa-tradeengine -n petrosa-apps
   kubectl --kubeconfig=k8s/kubeconfig.yaml rollout restart deployment/petrosa-ta-bot -n petrosa-apps
   ```

2. **Create Manual NATS Test**
   - Use NATS CLI or Python script to publish test message to `signals.trading`
   - Verify tradeengine receives it
   - This isolates whether issue is ta-bot publisher or NATS routing

3. **Check NATS Server Monitoring**
   ```bash
   kubectl --kubeconfig=k8s/kubeconfig.yaml port-forward -n nats nats-server-5d859c86df-42s4j 8222:8222
   curl http://localhost:8222/varz  # Server stats
   curl http://localhost:8222/connz # Connection stats
   curl http://localhost:8222/subsz # Subscription stats
   ```

## Technical Deep Dive

### ta-bot Publisher Flow
```python
# ta_bot/services/nats_listener.py:173
await self.publisher.publish_signals(signals)

# ta_bot/services/publisher.py:66
async def publish_signals(self, signals):
    # ... REST API publishing (disabled)
    await self._publish_via_nats(signals)  # Line 81

# ta_bot/services/publisher.py:116
async def _publish_via_nats(self, signals):
    if not self.nats_client:  # Line 118
        logger.error("‚ùå CRITICAL: Cannot publish to NATS - client not connected.")
        return

    for signal in signals:
        signal_data = signal.to_dict()
        subject = "signals.trading"  # Line 134
        message = json.dumps(signal_data).encode()
        await self.nats_client.publish(subject, message)  # Line 141
```

### tradeengine Consumer Flow
```python
# tradeengine/consumer.py:111
self.subscription = await self.nc.subscribe(
    settings.nats_signal_subject,  # "signals.trading"
    cb=self._message_handler,
)

# tradeengine/consumer.py:148
async def _message_handler(self, msg):
    logger.info("üì® NATS MESSAGE RECEIVED | Subject: %s | Size: %d bytes", msg.subject, len(msg.data))
    signal_data = json.loads(msg.data.decode())
    signal = Signal(**signal_data)
    result = await self.dispatcher.dispatch(signal)
```

## Conclusion

The configuration is correct, connections are established, but messages are not flowing. The most likely cause is a **timing issue** where ta-bot publishes before tradeengine subscribes, and there's no message persistence in NATS.

**Recommended Solution**:
1. Deploy enhanced logging to confirm publisher is actually calling `nats_client.publish()`
2. If confirmed, restart both services simultaneously to ensure proper subscription timing
3. Consider implementing message persistence (NATS JetStream) or database polling as fallback

## Files Modified

1. `/Users/yurisa2/petrosa/petrosa-bot-ta-analysis/ta_bot/main.py`
2. `/Users/yurisa2/petrosa/petrosa-bot-ta-analysis/ta_bot/services/publisher.py`
3. `/Users/yurisa2/petrosa/petrosa-bot-ta-analysis/ta_bot/services/nats_listener.py`
4. `/Users/yurisa2/petrosa/petrosa-bot-ta-analysis/ta_bot/health.py`
